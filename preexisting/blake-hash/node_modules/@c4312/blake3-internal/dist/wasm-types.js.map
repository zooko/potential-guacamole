{"version":3,"file":"wasm-types.js","sourceRoot":"","sources":["../src/wasm-types.ts"],"names":[],"mappings":"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","sourcesContent":["export interface WasmModule {\n  HEAPU8: Uint8Array;\n  _free(addr: number): void;\n  _malloc(bytes: number): number;\n  ccall<T extends number | boolean>(...args: unknown[]): T;\n}\n\nlet globalWasm: WasmModule | undefined;\n\nexport const setWasm = (m: WasmModule) => (globalWasm = m);\n\nexport const getWasm = () => {\n  if (!globalWasm) {\n    throw new Error(`Make sure to await blake3.load() before trying to use any functions`);\n  }\n\n  return globalWasm;\n};\n\nconst memoryDeallocator = new FinalizationRegistry<{\n  wasm: WasmModule;\n  address: number;\n}>((v) => v.wasm._free(v.address));\n\nexport const MAX_SCRATCH_SIZE = 1024 * 1024;\n\nclass Scratch {\n  private addr?: number;\n  private scratchSize = 32;\n\n  public get size() {\n    return this.scratchSize;\n  }\n\n  grow(n: number): number {\n    let grew = false;\n    while (this.scratchSize < n && this.scratchSize < MAX_SCRATCH_SIZE) {\n      this.scratchSize <<= 1;\n      grew = true;\n    }\n\n    if (!grew && this.addr !== undefined) {\n      return this.addr;\n    }\n\n    const wasm = getWasm();\n    if (this.addr !== undefined) {\n      memoryDeallocator.unregister(this);\n      wasm._free(this.addr);\n    }\n\n    return (this.addr = wasm._malloc(this.scratchSize));\n  }\n}\n\nexport const scratch = new Scratch();\n\nexport class HashRaw {\n  public static default() {\n    return new HashRaw(getWasm().ccall<number>('hasher_init', 'number', [], []));\n  }\n\n  public static keyed(key: Uint8Array | Uint8ClampedArray) {\n    if (key.byteLength !== 32) {\n      throw new RangeError(`BLAKE3 key must be exactly 32 bytes long`);\n    }\n    const wasm = getWasm();\n    const saddr = scratch.grow(32);\n    wasm.HEAPU8.set(key, saddr);\n    return new HashRaw(wasm.ccall('hasher_init_keyed', 'number', ['number'], [saddr]));\n  }\n\n  public static derive(key: Uint8Array) {\n    const wasm = getWasm();\n    const saddr = scratch.grow(key.byteLength);\n    wasm.HEAPU8.set(key, saddr);\n    return new HashRaw(\n      wasm.ccall('hasher_init_derive', 'number', ['number', 'number'], [saddr, key.byteLength]),\n    );\n  }\n\n  private addr?: { wasm: WasmModule; address: number };\n  public readonly scratch = scratch;\n\n  constructor(private hasher: number) {\n    this.addr = { wasm: getWasm(), address: hasher };\n    memoryDeallocator.register(this, this.addr, this);\n  }\n\n  update(address: number, length: number) {\n    if (!this.addr) {\n      throw new Error('Cannot use a hash after disposing it');\n    }\n\n    this.addr.wasm.ccall(\n      'hasher_update',\n      null,\n      ['number', 'number', 'number'],\n      [this.hasher, address, length],\n    );\n  }\n\n  read(seek: bigint, address: number, length: number) {\n    if (!this.addr) {\n      throw new Error('Cannot use a hash after disposing it');\n    }\n\n    this.addr.wasm.ccall(\n      'hasher_read',\n      null,\n      ['number', 'number', 'number', 'number', 'number'],\n      [this.hasher, Number(seek >> 32n), Number(seek & 0xffffffffn), address, length],\n    );\n  }\n\n  clone() {\n    if (!this.addr) {\n      throw new Error('Cannot use a hash after disposing it');\n    }\n\n    const addr = this.addr.wasm.ccall<number>('clone_hasher', null, ['number'], [this.hasher]);\n    return new HashRaw(addr);\n  }\n\n  public dispose() {\n    if (this.addr) {\n      memoryDeallocator.unregister(this);\n      this.addr.wasm._free(this.addr.address);\n      this.addr = undefined;\n    }\n  }\n}\n"]}